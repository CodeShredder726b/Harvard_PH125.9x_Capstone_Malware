---
title: "Report on Malware classification"
subtitle: "HarvardX Data Science Capstone Project"
author: "Raphael Kummer"
date: "`r format(Sys.Date())`"
output: 
  pdf_document:
    df_print: kable
    toc: yes
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, progress = TRUE, verbose = TRUE)
```
\newpage
# Malware
## Introduction
Malware, short for "malicious software", is a type of software designed to cause harm or damage to computer systems, networks, or devices. Malware can take various forms, including viruses, worms, Trojan horses, ransomware, spyware, adware, and others. Malware can be spread through various means such as email attachments, infected websites, or through exploiting security vulnerabilities in software or operating systems. Malware can cause a range of issues such as stealing personal information, encrypting files and demanding ransom, disrupting system operations, and causing damage to hardware or software components. As such, it is important to have proper security measures in place, such as antivirus software, firewalls, and regular software updates to protect against malware attacks.

### Dataset
The dataset *Malware static and dynamic features VxHeaven and Virus Total Data Set* [2] from the UCI Machine Learning Repository contains three csv. 

* staDynBenignLab.csv: 1086 features extracted from 595 files on MS Windows 7 and 8, obtained Program Files directory.
* staDynVxHeaven2698Lab.csv: 1087 features extracted from 2698 files of VxHeaven dataset.
* staDynVt2955Lab.csv: 1087 features extracted from 2955 provided by Virus Total in 2018.

The staDynBenignLab has all the features of typical non-threatening programs wheare as staDynVxHeaven2698Lab and staDynVt2955Lab are extracted features of malware programs from the databases of VxHeaven and Virus Total. 
The dataset provides static features like ASM, compiler version, operating system version, Hex dump and PE header [3] (portable executable) and dynamic features extracted from a cuckoo sandbox [4].
The dataset only contains windows specific programs and malware.

## Initial setup
Download the dataset from the UCI Machine Learning Repository Dataset and extract the containing csv files. Add a label to each of the csv, describing the class of program identified (e.g. class 0 for benign, class 1 for static malware features and class 2 for dynamic malware features).

## Goal
The dataset is used to explore and gain insight on how normal programs and malware differ in static and dynamic structure. Several machine learning algorithms to classify an unseen program as benign or malware (static or dynamic) are developed and compared.
Overall, the goal of this project is to improve our understanding of how malware differs from normal programs, and to develop effective techniques for automatically identifying and classifying malware based on its static and dynamic features.

## Summary
<TODO>

# Analysis
## Download
The zipped dataset is downloaded from the UCI archive and unzipped. 
  
```{r echo=FALSE, warning=FALSE}
# download dataset from UCI archive https://archive.ics.uci.edu/ml/datasets/Malware+static+and+dynamic+features+VxHeaven+and+Virus+Total#
download_url <- 'https://archive.ics.uci.edu/ml/machine-learning-databases/00541/datasets_DetectingMalwareUsingAHybridApproach.zip'
download.file(download_url, 'datasets.zip', mode='wb')

# unzip
unzip_result <- unzip("datasets.zip", overwrite = TRUE)
```
  
This will extract the following files:
```{r echo=TRUE}
list.files()
  
 # load these csv
benign <- read_csv("staDynBenignLab.csv")
vxheaven <- read_csv("staDynVxHeaven2698Lab.csv")
vt <- read_csv("staDynVt2955Lab.csv")
 ```
Where 
- *staDynBenignLab.csv* has `r { ncol(benign) }` features extracted from `r { nrow(benign) }` files on MS Windows 7 and 8, obtained Program Files directory
- *staDynVxHeaven2698Lab.csv* has `r { ncol(vxheaven) }` features extracted from `r { nrow(vxheaven) }` files of VxHeaven dataset.
- *staDynVt2955Lab.csv* has `r { ncol(vt) }` features extracted from `r { nrow(vt) }` provided by Virus Total in 2018.

## Preprocessing
Add classes to each dataset, depending on the origin of their data:
      
0: Normal *benign* programs 
1: Malware with static features extracted from the *VxHeaven (vxheaven)* dataset
2: Malware with dynamic features extracted from the *Virus Total (vt)* dataset

```
# classify each dataset
benign$class <- 0
vxheaven$class <- 1
vt$class <- 2
```
  
## Cleanup
The datasets have staDynBenignLab: `r sum(is.na(benign))`, staDynVxHeaven2698Lab: `r sum(is.na(vxheaven))` and staDynVt2955Lab: `r sum(is.na(vt))` missing values.

Check for features that not present in all three datasets, remove unique columns and combine all in one large dataset. 
```{r echo=FALSE}     
# remove unique columns
benign <- benign[, common_cols]
vxheaven <- vxheaven[, common_cols]
vt <- vt[, common_cols]
# now each dataset has 1085 features
      
# create one large dataset 
data <- rbind(benign, vxheaven, vt)
```
The resulting dataset we now work with has `r { ncol(benign) }` features for each of the `r { nrow(benign) }` different programs.

## Variance
Check feature variance for features without any relevant information, find all these features where the variation is 0 and remove them from the dataset.

```{r echo=TRUE}
# Calculate the variance of each variable in the dataset
variances <- apply(data, 2, var)

# Find which variances are equal to 0
zero_variances <- which(variances == 0)
```

`r { length(zero_variances)}` found to have a variance of 0. E.g. all variables of "count_file_renamed" are 0 so there is no benefit for the analysis or training of models. These are removed from the dataset and the remaining variances are plotted here:

```{r echo=TRUE}
# Exclude any variables with 0 variance
nonzero_variances <- variances[variances > 0]
# only 246 variables remain

# Create a bar plot of the variances
barplot(nonzero_variances, main="Log Variance", las=2, log="y", xlab="var", ylab="variance")
```

## Feature Clusters
### File/exe charakteristics
### Compiler/Linker charakteristics
### Imports
### Datatypes
### ASM and Functions used
### GUI and Menu
### Events
### System
### DLL

## Inspection

  

# Models
Test several machine learning approaches to classify unseen programs (according to their static and dynamic features) as benign or possibly malicious, differenciate between identified according to static or dynamic features.
The dataset is split into two parts, one for training and anoter for testing the model. The proportion of the data allocated to the test set is 30% of the complete data, the other 70% are used for the training set.

```{r echo=FALSE}
set.seed(42) # because 42 is always the answer

# split data into training and test set
test_index <- createDataPartition(y = data$class, times=1, p=0.3, list=FALSE)
colnames(data) <- make.names(colnames(data))

train_set <- data[-test_index,]
test_set <- data[test_index,]

ml_results <- tibble()
``` 
  
## Guessing
The simplest approach, though not very usefull, would be by simply guessing the classification of a program. It is expected that the accuracy would be 33.3%. 

```{r echo=FALSE}
guess_model <- factor(sample(c(0, 1, 2), length(test_set$class), replace=TRUE), levels=c(0,1,2))
guess_acc <- sum(guess_model == test_set$class) / nrow(test_set)
# expected to be around 33.3%

# Calculate F1 score
guess_cm <- confusionMatrix(table(factor(test_set$class), guess_model))
guess_f1 <- guess_cm$byClass[4]

ml_results <- ml_results %>%
  bind_rows(tibble(Model="Guessing", Accuracy=guess_acc, F1=guess_f1))
```
The accived accuracy is `r guess_acc`, close to the expected 33.3%.
`r knitr::kable(ml_results)`
  
## SVM
## KNN
## Random Forest
## Naive Bayes
## Decision Trees
## Gradient Boosting

# Conclusion
## Future Improvements
Bigger datasets like the one from Microsoft

Check other model approaches like
* Neuronal Network
* Gradient Descent

# System
## Hardware
All above computations are done with an `r {get_cpu().model_name}` CPU with `r {get_cpu().no_of_cores}` and `r {get_ram()}`` of RAM.
```{r}
#get_cpu()
#get_ram()
```

## Software
This report is compiled using R markdown with RStudio.
```{r}
sessionInfo()
```

# Resources
[1] Rafael Irizarry. 2018. Introduction to Data Science. <https://rafalab.dfci.harvard.edu/dsbook/>
[2] Malware static and dynamic features VxHeaven and Virus Total Data Set <https://archive.ics.uci.edu/ml/datasets/Malware+static+and+dynamic+features+VxHeaven+and+Virus+Total#>
[3] PE Format <https://learn.microsoft.com/en-us/windows/win32/debug/pe-format>
[4] cuckoo sandbox <https://cuckoosandbox.org/>

